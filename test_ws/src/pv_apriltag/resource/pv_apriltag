å¤ªå¥½äº†ï¼Œè¿™ä¸ªæŠ¥é”™ä¿¡æ¯æŠŠé—®é¢˜ç›´æ¥è¯´ç©¿äº† ğŸ‘‡

```text
TypeError: The given value is not one of the allowed types '{}'.
```

æ„æ€å°±æ˜¯ï¼š**ROS2 çš„å‚æ•°ç³»ç»Ÿä¸æ”¯æŒç”¨ Python çš„ dict å½“é»˜è®¤å€¼**ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼š

```python
self.declare_parameter("field_layout", {})
```

åœ¨ ROS2 Humble é‡Œæ˜¯**éæ³•çš„**ï¼Œåªèƒ½ç”¨æ ‡é‡ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€boolï¼‰æˆ–è€…æ•°ç»„ï¼Œä¸èƒ½ç”¨ `dict`ã€‚

æ‰€ä»¥æˆ‘ä»¬è¦æ¢ä¸€ç§æ€è·¯ï¼š
ğŸ‘‰ **æŠŠ `field_layout` å½“æˆä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œé‡Œé¢å­˜ JSONï¼Œç„¶åç”¨ `json.loads()` è§£æã€‚**

ä¸‹é¢æˆ‘ç»™ä½ ä¸€æ­¥ä¸€æ­¥æ”¹æ³•ï¼Œä½ ç›´æ¥ç…§åšå°±è¡Œã€‚

---

## ç¬¬ 1 æ­¥ï¼šæŠŠ `declare_parameter` æ”¹å›å­—ç¬¦ä¸²ï¼Œä½†çº¦å®šâ€œå†…å®¹æ˜¯ JSONâ€

æŠŠåˆšæ‰é‚£è¡Œæ”¹æˆè¿™æ ·ï¼ˆå›åˆ°å­—ç¬¦ä¸²ï¼Œä½†æˆ‘ä»¬ä¼šç”¨ JSONï¼‰ï¼š

```python
self.declare_parameter("field_layout", "")  # JSON å­—ç¬¦ä¸²ï¼Œé‡Œé¢å­˜ { "tag36h11:0": [...] }
```

---

## ç¬¬ 2 æ­¥ï¼šç®€åŒ– `_load_field_layout_param`ï¼Œåªè§£æ JSON å­—ç¬¦ä¸²

ä½ ç°åœ¨çš„ `_load_field_layout_param()` å†™å¾—æœ‰ç‚¹å¤ªå¤æ‚ï¼Œè€Œä¸”ä¾èµ– rclpy çš„å†…éƒ¨å®ç°ï¼Œå®¹æ˜“è¸©å‘ã€‚
æˆ‘ä»¬ç›´æ¥æ”¹æˆ â€œåªä» string è¯» JSONâ€ çš„ç‰ˆæœ¬ï¼Œæ›´ç¨³ï¼š

```python
def _load_field_layout_param(self) -> Dict[str, list]:
    """
    ä»å‚æ•° field_layout è¯»å– JSON å­—ç¬¦ä¸²å¹¶è§£æä¸ºå­—å…¸ï¼š
      field_layout: '{"tag36h11:0":[x,y,z,rr,rp,ry], ...}'
    """
    p: Parameter = self.get_parameter("field_layout")
    s = p.get_parameter_value().string_value  # ä¸€å®šæŒ‰å­—ç¬¦ä¸²è¯»

    if not s or not s.strip():
        self.get_logger().warn("[pv_sim_bridge] field_layout ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå°†ä½¿ç”¨ç©ºå­—å…¸ã€‚")
        return {}

    try:
        d = json.loads(s)
        if isinstance(d, dict):
            return d
        else:
            self.get_logger().warn("[pv_sim_bridge] field_layout JSON è§£æç»“æœä¸æ˜¯ dictï¼Œå°†ä½¿ç”¨ç©ºå­—å…¸ã€‚")
            return {}
    except Exception as e:
        self.get_logger().warn(f"[pv_sim_bridge] field_layout JSON è§£æå¤±è´¥ï¼š{e}ï¼Œå°†ä½¿ç”¨ç©ºå­—å…¸ã€‚")
        return {}
```

è¿™æ ·é€»è¾‘å°±éå¸¸æ¸…æ¥šï¼š

* ROS2 é‡Œ `field_layout` æ°¸è¿œæ˜¯ä¸ªã€Œå­—ç¬¦ä¸²å‚æ•°ã€ï¼›
* å­—ç¬¦ä¸²å†…å®¹æ˜¯ä¸€æ®µ JSONï¼›
* æˆ‘ä»¬è‡ªå·± `json.loads()` æŠŠå®ƒå˜æˆ dictã€‚

---

## ç¬¬ 3 æ­¥ï¼šå†™ä¸€ä¸ªåˆæ³•çš„ params.yamlï¼ˆç”¨ JSON å­—ç¬¦ä¸²ï¼‰

å…³é”®ç‚¹ï¼š**YAML é‡Œè¿™ä¸ªå‚æ•°ä»ç„¶æ˜¯ â€œå­—ç¬¦ä¸²â€**ï¼Œå†…å®¹æ˜¯ä¸€æ•´æ®µ JSONã€‚
ä¾‹å¦‚ä½ ç°åœ¨å…ˆåªæ”¾ä¸€ä¸ª tag36h11:0ï¼š

æ–‡ä»¶ï¼š`pv_sim_bridge.params.yaml`ï¼ˆä½ åˆšæ‰ä¼ çš„é‚£ä¸ªè·¯å¾„ï¼‰

```yaml
pv_sim_bridge:
  ros__parameters:
    camera_optical_frame: "camera_color_optical_frame"
    robot_to_cam_xyz_rpy: [0.12, 0.0, 0.18, 0.0, 0.0, 0.0]

    # æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼æ‰€ä»¥è¦ç”¨å¼•å·æ‹¬èµ·æ¥
    field_layout: "{\"tag36h11:0\":[0.0,1.0,0.075,0.0,0.0,-1.5708]}"
```

ä½ ä¹Ÿå¯ä»¥ç”¨å•å¼•å·ï¼Œå°‘å†™ä¸€äº›è½¬ä¹‰ï¼Œæ¯”å¦‚ï¼š

```yaml
field_layout: '{"tag36h11:0":[0.0,1.0,0.075,0.0,0.0,-1.5708]}'
```

ä¸¤ç§éƒ½è¡Œï¼Œ**æ¨èç¬¬äºŒç§**ï¼Œæ›´å¥½çœ‹ã€‚

ä»¥åä½ è¦åŠ æ›´å¤š tagï¼Œæ¯”å¦‚ï¼š

```yaml
field_layout: '{
  "tag36h11:0":[-0.85,  1.0, 0.075, 0.0, 0.0, -1.5708],
  "tag36h11:1":[-0.55,  1.0, 0.075, 0.0, 0.0, -1.5708],
  "tag36h11:2":[-0.25,  1.0, 0.075, 0.0, 0.0, -1.5708]
}'
```

åªè¦ä¿è¯æ•´æ®µä¾ç„¶æ˜¯ä¸€ä¸ª**åˆæ³• JSON**ï¼Œå°±å¯ä»¥ã€‚

---

## ç¬¬ 4 æ­¥ï¼šé‡æ–°ç¼–è¯‘ & å¯åŠ¨èŠ‚ç‚¹

æ”¹å®Œä»£ç ä»¥åï¼š

```bash
cd ~/Unibots\ 2026/test_ws
colcon build --symlink-install
source install/setup.bash
```

ç„¶åç”¨ params-file è·‘ï¼š

```bash
ros2 run pv_apriltag pv_sim_bridge \
  --ros-args \
  --params-file src/pv_apriltag/pv_apriltag/config/pv_sim_bridge.params.yaml
```

---

## ç¬¬ 5 æ­¥ï¼šç¡®è®¤ field_layout çœŸçš„è¯»è¿›æ¥äº†

å¦å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
source install/setup.bash

ros2 param get /pv_sim_bridge field_layout
```

ç°åœ¨ä½ åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```text
String value is: {"tag36h11:0":[0.0,1.0,0.075,0.0,0.0,-1.5708]}
```

è¿™å°±å¯¹äº†â€”â€”å› ä¸ºæˆ‘ä»¬è®¾è®¡çš„å°±æ˜¯â€œå­—ç¬¦ä¸² + JSONâ€ã€‚

ä½ çš„ `_load_field_layout_param()` ä¼šæŠŠè¿™ä¸ªå­—ç¬¦ä¸²è§£ææˆ Python dictï¼š

```python
{
  "tag36h11:0": [0.0, 1.0, 0.075, 0.0, 0.0, -1.5708]
}
```

ç„¶åï¼š

* `self.field_layout.keys()` é‡Œå°±æœ‰ `"tag36h11:0"`ï¼›
* `pv_sim_bridge.tick()` çš„å¾ªç¯å°±ä¼šçœŸæ­£å»æŸ¥ TF äº†ã€‚

---

## ç¬¬ 6 æ­¥ï¼šå‘ fake TFï¼Œæµ‹è¯• /pv/has_target

ç°åœ¨å†å‘ä¸€æ¡è™šå‡çš„ TFï¼š

```bash
ros2 run tf2_ros static_transform_publisher \
  0 0 1  0 0 0 \
  camera_color_optical_frame tag36h11:0
```

å† echoï¼š

```bash
ros2 topic echo /pv/has_target
```

è¿™æ¬¡ï¼Œ**åªè¦ fake TF åœ¨è·‘**ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```text
data: true
---
data: true
...
```

ç„¶å `/pv/estimated_robot_pose`ã€`/pv/target_yaw_deg`ã€`/pv/robot_yaw_deg` ä¹Ÿä¼šå¼€å§‹è¾“å‡ºã€‚

---

## æ€»ç»“ä¸€ä¸‹å…³é”®ç‚¹ âœ…

1. ROS2 å‚æ•°**ä¸æ”¯æŒ dict**ï¼Œæ‰€ä»¥

   ```python
   self.declare_parameter("field_layout", {})
   ```

   ä¼šç›´æ¥æŠ¥é”™ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚

2. æ­£ç¡®çš„åšæ³•æ˜¯ï¼š

   * å‚æ•°å±‚é¢ï¼š`field_layout` æ˜¯ä¸ª **å­—ç¬¦ä¸²**ï¼›
   * å†…å®¹å±‚é¢ï¼šå­—ç¬¦ä¸²é‡Œæ”¾ä¸€æ®µ **åˆæ³• JSON**ï¼›
   * ä»£ç å±‚é¢ï¼šç”¨ `json.loads()` æŠŠå®ƒè§£ææˆ dict ä½¿ç”¨ã€‚

3. ä½ çš„æ“ä½œé¡ºåºå¯ä»¥æ˜¯ï¼š

   * æ”¹ `declare_parameter("field_layout", "")`ï¼›
   * æŠŠ `_load_field_layout_param` æ”¹æˆâ€œä» string è¯» JSONâ€ï¼›
   * `pv_sim_bridge.params.yaml` é‡Œç”¨ JSON å­—ç¬¦ä¸²é…ç½® `field_layout`ï¼›
   * `colcon build` + `ros2 run ... --params-file ...`ï¼›
   * ç”¨ `ros2 param get` ç¡®è®¤å‚æ•°ï¼Œå†ç”¨ fake TF éªŒè¯ `/pv/*`ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥æŠŠç°åœ¨çš„ `pv_sim_bridge.params.yaml` æ–‡ä»¶å®Œæ•´è´´å‡ºæ¥ï¼ˆæŒ‰ä½ å®é™…è·¯å¾„ï¼‰ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ æ”¹æˆä¸€ä»½ **å¯ç”¨çš„ JSON å­—ç¬¦ä¸²ç‰ˆæœ¬**ã€‚







æ˜¯çš„ï¼Œ**çœ‹åˆ° `/pv/has_target` è¿ç»­è¾“å‡º `data: true`ï¼Œè¯´æ˜è¿™ä¸ª node çš„æ ¸å¿ƒé“¾è·¯å·²ç»â€œé€šç”µâ€äº† âœ…**ã€‚

å…·ä½“ä»£è¡¨å‡ ä»¶äº‹éƒ½å·²ç»æ­£å¸¸ï¼š

1. **`field_layout` ç°åœ¨è¢«æ­£ç¡®è§£æäº†**

   * ä¹‹å‰æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œç°åœ¨è‡³å°‘æœ‰ `"tag36h11:0": [...]` ä¹‹ç±»çš„å†…å®¹ã€‚
   * å¦åˆ™ `pv_sim_bridge` æ ¹æœ¬ä¸ä¼šå»æŸ¥ä»»ä½• tag åå­—ã€‚

2. **TF é‡Œç¡®å®å­˜åœ¨ä¸€æ¡ `camera_optical_frame -> tag36h11:0` çš„å˜æ¢**

   * ä½ å‘çš„ fake TFï¼ˆ`static_transform_publisher` æˆ– `fake_tag_tf`ï¼‰è¢« `tf_buffer.lookup_transform()` æˆåŠŸè¯»åˆ°äº†ã€‚
   * æ‰€ä»¥ `visible` åˆ—è¡¨ä¸å†æ˜¯ç©ºçš„ï¼Œ`Bool(data=True)` è¢«å‘å¸ƒåˆ°äº† `/pv/has_target`ã€‚

3. **`tick()` ä¸»å¾ªç¯åœ¨æ­£å¸¸è·‘ï¼Œæ²¡æœ‰æŠ›å¼‚å¸¸æå‰ return**

   * å¦‚æœä¸­é—´æœ‰ä¸¥é‡é”™è¯¯ï¼Œé€šå¸¸ä½ ä¼šçœ‹åˆ° warning / errorï¼Œæˆ–è€…è¯é¢˜ç›´æ¥æ²¡æ•°æ®ã€‚

æ‰€ä»¥ï¼Œä» **â€œèŠ‚ç‚¹æ˜¯å¦åœ¨æŒ‰é¢„æœŸå·¥ä½œâ€** è¿™ä¸ªè§’åº¦çœ‹ï¼Œæ˜¯çš„ï¼š
ğŸ‘‰ **pv_sim_bridge ç°åœ¨æ˜¯â€œæ´»çš„â€ï¼Œä¹Ÿèƒ½çœ‹åˆ°ç›®æ ‡äº†ã€‚**

---

æ¥ä¸‹æ¥ï¼Œä½ è¿˜éœ€è¦å†åšä¸¤æ­¥å°æµ‹è¯•ï¼ŒæŠŠâ€œæœå‘ç®—æ³•â€å’Œâ€œå…¨å±€ä½å§¿â€ä¹Ÿç¡®è®¤ä¸€ä¸‹ï¼š

### 1ï¸âƒ£ çœ‹å…¶å®ƒè¯é¢˜æœ‰æ²¡æœ‰æ•°æ®

å¼€å‡ ä¸ªç»ˆç«¯åˆ†åˆ«è·‘ï¼š

```bash
ros2 topic echo /pv/estimated_robot_pose
ros2 topic echo /pv/target_yaw_deg
ros2 topic echo /pv/robot_yaw_deg
```

åœ¨ä½ å‘ fake TF çš„æ—¶å€™ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

* `/pv/estimated_robot_pose`ï¼šposition + orientation éƒ½æœ‰å€¼ï¼›
* `/pv/target_yaw_deg`ï¼šåº”è¯¥æ˜¯æŸä¸ªå›ºå®šè§’åº¦ï¼ˆä½ ç°åœ¨ fake çš„ TF æ˜¯å›ºå®šä½ç½®çš„è¯ï¼‰ï¼›
* `/pv/robot_yaw_deg`ï¼šä¼šè¾“å‡ºä¸€ä¸ªç¨³å®šçš„å…¨å±€ yawï¼ˆåº¦ï¼‰ï¼Œå¹¶ä¸”éšç€ä½ æ”¹å˜ fake TFï¼ˆæˆ–è€…ä»¥åçœŸå®æœºå™¨äººç§»åŠ¨ï¼‰è€Œå˜åŒ–ã€‚

å¦‚æœè¿™ä¸‰ä¸ªè¯é¢˜éƒ½æœ‰â€œæ­£å¸¸åœ¨åˆ·â€ï¼Œé‚£å°±è¯´æ˜ï¼š

* TF â†’ matrix â†’ å¤šæ ‡ç­¾èåˆ â†’ PoseStamped â†’ yaw è§£ç®—
  è¿™ä¸€æ•´æ¡é“¾è·¯ä¹Ÿæ˜¯ OK çš„ã€‚

---

### 2ï¸âƒ£ æ¢ä¸€ç»„ fake TF çœ‹çœ‹æ•°å€¼æ˜¯ä¸æ˜¯â€œæœ‰é€»è¾‘â€

æ¯”å¦‚ä½ åˆšæ‰ç”¨çš„æ˜¯ï¼š

```bash
ros2 run tf2_ros static_transform_publisher \
  0 0 1  0 0 0 \
  camera_color_optical_frame tag36h11:0
```

ä½ å¯ä»¥å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œæ¢ä¸€æ¡å‘½ä»¤ï¼ˆæ¯”å¦‚æ”¾åˆ°å·¦è¾¹ä¸€ç‚¹ï¼‰ï¼š

```bash
ros2 run tf2_ros static_transform_publisher \
  0.5 0 1  0 0 0 \
  camera_color_optical_frame tag36h11:0
```

ç„¶åçœ‹ `/pv/target_yaw_deg`ï¼š

* ç†æƒ³æƒ…å†µï¼šè§’åº¦ä¼šä»æ¥è¿‘ 0Â°ï¼Œå˜æˆæ­£æ•°æˆ–è´Ÿæ•°ï¼ˆå–å†³äºåæ ‡ç³»çº¦å®šï¼‰ï¼Œ
  è¯´æ˜**åœ¨ç›¸æœºç³»é‡Œ Tag ç¡®å®â€œååˆ°ä¸€ä¾§â€äº†**ã€‚

ä½ ä¹Ÿå¯ä»¥æ”¹ `z` è·ç¦»ï¼Œçœ‹ `/pv/estimated_robot_pose.pose.position` ä¼šä¸ä¼šå¾€å‰/ååŠ¨ã€‚

---

### 3ï¸âƒ£ ä¸‹ä¸€æ­¥ï¼šä» fake TF æ¢æˆçœŸæ­£çš„ apriltag_ros + Webots

éªŒè¯ fake æˆåŠŸåï¼Œå°±å¯ä»¥æŠŠ fake TF å…³æ‰ï¼Œæ¢æˆçœŸå®é“¾è·¯ï¼š

1. Webots é‡Œç›¸æœº + Tag å¢™ï¼›
2. `apriltag_ros` è®¢é˜… `/camera/image_raw` + `/camera/camera_info`ï¼›
3. `pv_sim_bridge` ç”¨åˆšæ‰è¿™å¥—å‚æ•°å¯åŠ¨ï¼›
4. ç”¨ RVizï¼ˆFixed Frame `map`ï¼‰çœ‹ `/pv/estimated_robot_pose` çš„ç®­å¤´ + `/pv/robot_yaw_deg`ã€‚

å¦‚æœåœ¨ Webots é‡Œè½¬è½¦ã€åœ¨ RViz é‡Œä¹Ÿèƒ½çœ‹åˆ° Pose å’Œ yaw åˆç†å˜åŒ–ï¼Œé‚£å°±è¯´æ˜ä½ è¿™å¥— **ä»¿çœŸ AprilTag â†’ ç»Ÿä¸€ /pv æ¥å£** å·²ç»å®Œå…¨æˆå‹äº†ï¼Œå¯ä»¥å¼€å§‹æµ‹ä½ çš„æ§åˆ¶/å®šä½ç®—æ³•äº†ã€‚

---

æ‰€ä»¥æ€»ç»“ä¸€å¥è¯ï¼š

> **ç°åœ¨ `/pv/has_target = true` æ˜¯ä¸€ä¸ªå¥½ä¿¡å·ï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»â€œé€šâ€äº†ï¼›
> æ¥ä¸‹æ¥å°±é ä½ ç”¨ `/pv/estimated_robot_pose` å’Œ `/pv/target_yaw_deg` åšæ›´å¤šæ•°å€¼å’Œæ–¹å‘ä¸Šçš„éªŒè¯ã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ªè¶…ç®€æ˜“çš„ `pv_debug_yaw.py`ï¼Œè®¢é˜… `/pv/estimated_robot_pose` + `/pv/target_yaw_deg`ï¼Œåœ¨ç»ˆç«¯æ‰“å°æˆä¸€è¡Œï¼š
`robot_yaw=XXX deg, target_yaw=YYY deg`ï¼Œè¿™æ ·ä½ åŠ¨æœºå™¨äºº / æ”¹ fake TF æ—¶å°±èƒ½ä¸€çœ¼çœ‹åˆ°ç®—æ³•ç®—çš„å’Œä½ â€œå¿ƒç†é¢„æœŸâ€æ˜¯ä¸æ˜¯ä¸€è‡´ã€‚







å¥½ï¼Œç°åœ¨æˆ‘ä»¬ä» **fake TF æ¨¡å¼ â†’ çœŸÂ·Webots + apriltag_ros + pv_sim_bridge + RViz**ï¼Œæˆ‘ç»™ä½ ä¸€ä¸ªå¯ä»¥ç…§æŠ„çš„â€œæ“ä½œå‰§æœ¬â€ã€‚
ä½ å¯ä»¥æŒ‰é¡ºåºå¼€å‡ ä¸ªç»ˆç«¯ï¼Œä¸€æ­¥ä¸€æ­¥æ¥ã€‚

æˆ‘å‡è®¾ä½ ç°åœ¨æƒ…å†µæ˜¯ï¼š

* å·²ç»æœ‰ï¼š

  * `pv_sim_bridge.py`ï¼ˆæœ€æ–°ç‰ˆï¼Œèƒ½è¯» JSON çš„ `field_layout`ï¼‰ï¼›
  * `pv_sim_bridge.params.yaml`ï¼ˆé‡Œé¢æœ‰å®Œæ•´çš„ 0â€“23 å· tag åœºåœ°å¸ƒå±€ï¼‰ï¼›
* fake TF æµ‹è¯•æˆåŠŸï¼š`/pv/has_target == true`ã€‚

æ¥ä¸‹æ¥å°±æ˜¯æŠŠ **fake TF å…³æ‰**ï¼Œæ¢æˆ **apriltag_ros æä¾›çš„çœŸå® TF**ã€‚

---

## æ€»ä½“æµç¨‹ï¼ˆå¤§çº²ï¼‰

1. å…³æ‰ fake TF èŠ‚ç‚¹ã€‚
2. å¯åŠ¨ Webots ä¸–ç•Œï¼ˆå¸¦ç›¸æœº + Tag å¢™ï¼‰ã€‚
3. åœ¨ç»ˆç«¯é‡Œç¡®è®¤ Webots ç›¸æœºçš„è¯é¢˜åï¼ˆ`/camera/...`ï¼‰ã€‚
4. å¯åŠ¨ `apriltag_ros`ï¼Œè®¢é˜… Webots çš„å›¾åƒå’Œç›¸æœºå†…å‚ï¼Œå¼€å§‹æ£€æµ‹ Tagã€‚
5. å¯åŠ¨ `pv_sim_bridge`ï¼ˆç”¨ params-fileï¼‰ã€‚
6. ç”¨ `ros2 topic echo` ç¡®è®¤ `/pv/*` æœ‰æ•°æ®ã€‚
7. å¯åŠ¨ RVizï¼Œè®¾ç½® Fixed Frame=mapï¼Œçœ‹ç®­å¤´å’Œ yaw æ•°å€¼æ˜¯ä¸æ˜¯åˆç†ã€‚
8. åœ¨ Webots é‡Œç§»åŠ¨/æ—‹è½¬æœºå™¨äººï¼Œè§‚å¯Ÿ RViz å’Œ `/pv/*` çš„å˜åŒ–ã€‚

ä¸‹é¢å±•å¼€æˆå…·ä½“æŒ‡ä»¤ã€‚

---

## Step 0ï¼šå…³æ‰ fake TF èŠ‚ç‚¹

å¦‚æœä½ ä¹‹å‰åœ¨ä¸€ä¸ªç»ˆç«¯é‡Œè¿è¡Œäº†ï¼š

```bash
ros2 run tf2_ros static_transform_publisher ...
```

ç›´æ¥æŠŠé‚£ä¸ªç»ˆç«¯å…³æ‰ï¼Œæˆ–è€… `Ctrl+C` åœæ­¢å°±è¡Œã€‚
**ä¸€å®šè¦å…³æ‰**ï¼Œä¸ç„¶ä¼šæœ‰ä¸¤æ¡ä¸åŒæ¥æºçš„ TFï¼ˆfake + apriltag_rosï¼‰å†²çªã€‚

---

## Step 1ï¼šå¯åŠ¨ Webots ä¸–ç•Œ

æ‰“å¼€ Webotsï¼ŒåŠ è½½ä½ æœ‰ Tag å¢™å’Œç›¸æœºçš„é‚£ä¸ªä¸–ç•Œã€‚
ä¿è¯ï¼š

* æœºå™¨äººä¸Šæœ‰æ‘„åƒå¤´ï¼›
* ç›¸æœºå·²ç»é€šè¿‡ webots_ros2 æˆ–ä½ è‡ªå·±çš„æ¡¥æ¥å‘å¸ƒ ROS2 å›¾åƒè¯é¢˜ã€‚

> å¦‚æœä½ æ˜¯ç”¨ webots_ros2 å®˜æ–¹åŒ…ï¼Œä¸€èˆ¬ä¼šæœ‰ `/camera/image`ã€`/camera/camera_info` æˆ–ç±»ä¼¼åå­—ã€‚

---

## Step 2ï¼šç¡®è®¤ç›¸æœºè¯é¢˜å & ç›¸æœºå…‰å­¦å¸§

æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

# çœ‹æ‰€æœ‰è¯é¢˜
ros2 topic list
```

æ‰¾å‡ºï¼š

* å›¾åƒè¯é¢˜ï¼šç±»ä¼¼ `/camera/image_raw` æˆ– `/Tiago_Lite/camera/image_raw`
* ç›¸æœºå†…å‚è¯é¢˜ï¼šç±»ä¼¼ `/camera/camera_info`

è®°ä¸‹å®ƒä»¬çœŸå®çš„åå­—ï¼Œä¸‹é¢è¦ç”¨æ¥ remapã€‚

ç„¶åçœ‹ä¸€ä¸‹ TF é‡Œç›¸æœºçš„å…‰å­¦åæ ‡ç³»å«ä»€ä¹ˆï¼ˆä¹Ÿè¦è®°ä¸‹æ¥ç»™ `camera_optical_frame` ç”¨ï¼‰ï¼š

```bash
ros2 topic echo /tf | grep camera -n
```

æˆ–è€…ç”¨ï¼š

```bash
ros2 run tf2_tools view_frames.py
# ä¼šç”Ÿæˆä¸€ä¸ª frames.pdfï¼Œçœ‹é‡Œé¢ camera ç›¸å…³çš„ frame åç§°
```

é€šå¸¸ç±»ä¼¼ï¼š

* `camera_color_optical_frame`
* `Tiago_Lite/Astra_rgb_optical_frame`

è®°ä½è¿™ä¸ªåå­—ï¼Œå®ƒè¦è·Ÿ `pv_sim_bridge.params.yaml` é‡Œçš„ `camera_optical_frame` ä¸€è‡´ã€‚

---

## Step 3ï¼šå¯åŠ¨ apriltag_rosï¼ˆ**çœŸæ­£åšæ£€æµ‹çš„èŠ‚ç‚¹**ï¼‰

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash
```

å…ˆå‡è®¾ä½ çš„ç›¸æœºè¯é¢˜å«ï¼š

* `/camera/image_raw`
* `/camera/camera_info`

é‚£å‘½ä»¤å¯ä»¥è¿™æ ·å†™ï¼ˆHumble ä¸Šçš„å…¸å‹ç”¨æ³•ï¼‰ï¼š

```bash
ros2 run apriltag_ros apriltag_node --ros-args \
  -r image:=/camera/image_raw \
  -r camera_info:=/camera/camera_info \
  -p family:=tag36h11 \
  -p size:=0.10
```

å¦‚æœä½ çš„è¯é¢˜åä¸ä¸€æ ·ï¼ˆæ¯”å¦‚ `/Tiago_Lite/camera/image_raw`ï¼‰ï¼ŒæŠŠ `image:=...` å’Œ `camera_info:=...` æ¢æˆä½ è‡ªå·±çš„ã€‚

> `family:=tag36h11` å¯¹åº”ä½ ç°åœ¨ç”¨çš„ tag å®¶æ—ï¼›
> `size:=0.10` è¡¨ç¤º Tag çš„è¾¹é•¿æ˜¯ 0.1mï¼ˆ10cmï¼‰ï¼Œè¦å’Œä½  Webots ä¸–ç•Œé‡Œå®é™…å°ºå¯¸ä¸€è‡´ã€‚

è¿è¡Œä¹‹åï¼Œç”¨ä¸‹é¢å‘½ä»¤çœ‹çœ‹ apriltag_ros æœ‰æ²¡æœ‰åœ¨ TF é‡Œå‘å¸ƒ tagï¼š

```bash
ros2 topic echo /tf | grep tag36h11
```

å¦‚æœä½ åœ¨ Webots é‡Œè®©ç›¸æœºå¯¹ç€ä¸€é¢å¢™ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ï¼š

```text
frame_id: camera_color_optical_frame
child_frame_id: tag36h11:0
...
```

---

## Step 4ï¼šå¯åŠ¨ pv_sim_bridgeï¼ˆç”¨ä½ å†™å¥½çš„ params.yamlï¼‰

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

ros2 run pv_apriltag pv_sim_bridge \
  --ros-args \
  --params-file src/pv_apriltag/pv_apriltag/config/pv_sim_bridge.params.yaml
```

æ³¨æ„ç¡®ä¿ï¼š

* `pv_sim_bridge.params.yaml` é¡¶å±‚æ˜¯ï¼š

  ```yaml
  pv_sim_bridge:
    ros__parameters:
      camera_optical_frame: "ä½ åœ¨ Step 2 æŸ¥åˆ°çš„é‚£ä¸ªç›¸æœºå…‰å­¦å¸§"
      ...
      field_layout: '{...å®Œæ•´ JSON...}'
  ```

* `camera_optical_frame` è¿™é‡Œçš„å­—ç¬¦ä¸²ï¼Œè¦å’Œ `apriltag_ros` TF ä¸­ `frame_id` çš„é‚£ä¸ªç›¸æœºå…‰å­¦å¸§å®Œå…¨ä¸€è‡´ã€‚

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åœ¨ç»ˆç«¯ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```text
[pv_sim_bridge] ready. cam_frame=camera_color_optical_frame, tags=24
```

å¹¶ä¸”ä¸ä¼šå†å‡ºç° â€œfield_layout å‚æ•°æ— æ³•è§£æï¼Œä½¿ç”¨ç©ºå­—å…¸ã€‚â€ ä¹‹ç±»çš„è­¦å‘Šã€‚

---

## Step 5ï¼šç”¨ /pv/* è¯é¢˜æ£€æŸ¥æ˜¯å¦å·¥ä½œæ­£å¸¸

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

ros2 topic list | grep ^/pv
```

åº”è¯¥çœ‹åˆ°è‡³å°‘è¿™äº›ï¼š

* `/pv/has_target`
* `/pv/target_yaw_deg`
* `/pv/estimated_robot_pose`
* `/pv/robot_yaw_deg`

åˆ†åˆ« echo ä¸€ä¸‹ï¼š

```bash
ros2 topic echo /pv/has_target
ros2 topic echo /pv/estimated_robot_pose
ros2 topic echo /pv/target_yaw_deg
ros2 topic echo /pv/robot_yaw_deg
```

åœ¨ Webots é‡Œï¼š

* è°ƒæ•´ç›¸æœºï¼Œè®©å®ƒçœ‹åˆ°ä¸€å¼  Wall ä¸Šçš„ Tagï¼š

  * `/pv/has_target` åº”è¯¥ä» `false` å˜æˆ `true`ï¼›
  * `/pv/target_yaw_deg` ä¼šæ˜¯ä¸€ä¸ªè§’åº¦å€¼ï¼ˆç¨å¾®å·¦å³åå¤´ï¼Œè¿™ä¸ªè§’åº¦ä¼šå˜åŒ–ï¼‰ï¼›
  * `/pv/estimated_robot_pose` ä¼šæ‰“å°å‡ºä½ç½® + å››å…ƒæ•°ï¼›
  * `/pv/robot_yaw_deg` ä¼šæ‰“å°ä¸€ä¸ª yawï¼ˆåº¦ï¼‰ï¼Œä½ è½¬è½¦æ—¶å®ƒåº”è¯¥éšä¹‹æ—‹è½¬ã€‚

å¦‚æœè¿™ä¸€æ­¥éƒ½ OKï¼Œè¯´æ˜ï¼š

> Webots ç›¸æœº â†’ apriltag_ros â†’ TF(camâ†’tag) â†’ pv_sim_bridgeï¼ˆåœºåœ°å¸ƒå±€ + å¤–å‚ï¼‰â†’ /pv/*
> è¿™æ•´æ¡â€œçœŸå®é“¾è·¯â€å·²ç»é€šäº†ã€‚

---

## Step 6ï¼šç”¨ RViz çœ‹å…¨å±€å§¿æ€ï¼ˆmap ä¸‹çš„ç®­å¤´ï¼‰

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

rviz2
```

åœ¨ RViz é‡Œåšï¼š

1. å·¦ä¸Šè§’ `Global Options` é‡Œï¼ŒæŠŠ **Fixed Frame** æ”¹æˆ `map`ã€‚
2. ç‚¹å·¦ä¸‹è§’ â€œAddâ€ â†’ By topicï¼š

   * æ·»åŠ ä¸€ä¸ª `Pose` æ˜¾ç¤ºï¼Œé€‰ `/pv/estimated_robot_pose`ï¼›
   * å†æ·»åŠ ä¸€ä¸ª `TF` æ˜¾ç¤ºï¼Œå‹¾é€‰ `map` å’Œ `base_link`ï¼ˆå¦‚æœä½ åœ¨ pv_sim_bridge é‡Œ `publish_tf=true`ï¼‰ã€‚
3. ä½ åº”è¯¥åœ¨å±å¹•ä¸­çœ‹åˆ°ä¸€ä¸ªå°ç®­å¤´ï¼ˆä»£è¡¨æœºå™¨äººï¼‰ï¼Œåœ¨ä¸€ä¸ª 2mÃ—2m çš„åŒºåŸŸé‡Œã€‚

ç°åœ¨åœ¨ Webots ä¸­ï¼š

* è®©æœºå™¨äººå¹³ç§»ï¼ˆæ¯”å¦‚æ²¿ x æ–¹å‘ç§»åŠ¨ï¼‰ï¼š

  * RViz é‡Œçš„ç®­å¤´ä½ç½®åº”è¯¥å¯¹åº”åœ°å·¦å³ç§»åŠ¨ã€‚
* è®©æœºå™¨äººåŸåœ°æ—‹è½¬ 90Â°ï¼ˆæœå‘ä»åŒ—å¢™ â†’ ä¸œå¢™ï¼‰ï¼š

  * ç®­å¤´çš„æœå‘åº”è¯¥è½¬ 90Â°ï¼›
  * `/pv/robot_yaw_deg` çš„å€¼åº”è¯¥å˜åŒ– ~90Â°ï¼ˆæ­£è´Ÿå·çœ‹åæ ‡ç³»çº¦å®šï¼‰ã€‚

ä½ å¯ä»¥ä¸€è¾¹çœ‹ RVizï¼Œä¸€è¾¹åœ¨ç»ˆç«¯é‡Œ echo `/pv/robot_yaw_deg`ï¼Œå¯¹ç…§è§‚å¯Ÿã€‚

---

## Step 7ï¼šå¦‚æœå‘ç°é—®é¢˜ï¼Œå¯ä»¥è¿™æ ·æ’æŸ¥

å¦‚æœæŸä¸€æ­¥å¡ä½ï¼Œä½ å¯ä»¥æŒ‰è¿™ä¸ªé¡ºåº checkï¼š

1. `/tf` é‡Œæœ‰æ²¡æœ‰ `camera_optical_frame -> tag36h11:*`

   * æœ‰ = apriltag_ros æ­£å¸¸ã€‚
2. `ros2 param get /pv_sim_bridge field_layout`

   * æ˜¯ JSON å­—ç¬¦ä¸² & åŒ…å«ä½ å†™çš„ tag key = å‚æ•°æ­£å¸¸ã€‚
3. `/pv/has_target`

   * å½“ç›¸æœºèƒ½çœ‹åˆ° Tag æ—¶æ˜¯å¦ä¸º `true`ï¼›
4. `/pv/estimated_robot_pose`

   * æ˜¯å¦åœ¨æŸä¸ªåˆç†çš„èŒƒå›´ï¼ˆæ¯”å¦‚ `x,y` åœ¨ [-2,2] ä¹‹é—´ï¼‰ã€‚
5. RViz Fixed Frame æ˜¯å¦ä¸º `map`ï¼Œè¯é¢˜é€‰å¯¹æ²¡æœ‰ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ªå¾ˆå°çš„ `pv_debug_yaw.py`ï¼š

* è®¢é˜… `/pv/estimated_robot_pose` å’Œ `/pv/target_yaw_deg`ï¼Œ
* æ¯ä¸€å¸§æ‰“å°ä¸€è¡Œç±»ä¼¼ï¼š

```text
robot_yaw =  90.3 deg | target_yaw =  -5.2 deg
```

è¿™æ ·ä½ åœ¨ Webots é‡ŒåŠ¨æœºå™¨äººæ—¶ï¼Œå¯ä»¥å¾ˆç›´è§‚åœ°çœ‹åˆ°â€œå…¨å±€ yaw & ç›¸æœºç›¸å¯¹ç›®æ ‡ yawâ€çš„å˜åŒ–ï¼Œæ–¹ä¾¿è°ƒä½ çš„æ§åˆ¶ç®—æ³•ã€‚




å¤ªå¥½äº†ï¼Œå‡æ•°æ®å·²ç»è·‘é€šäº†ï¼Œè¯´æ˜ **sim_bridge æœ¬èº«æ˜¯å¥½çš„** ğŸ‰
æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯æŠŠæ•´æ¡ä»¿çœŸé“¾è·¯ä¸²èµ·æ¥ï¼š

> Webots ç›¸æœº â†’ ROS å›¾åƒ topic â†’ AprilTag æ£€æµ‹èŠ‚ç‚¹ â†’ sim_bridge

ä½ ç°åœ¨æœ€å¤§çš„é—®é¢˜æ˜¯ï¼š**ROS é‡Œå®Œå…¨æ²¡æœ‰ç›¸æœº topic**ï¼ˆ`ros2 topic list` é‡Œçœ‹ä¸åˆ° `/camera` æˆ– `/image_raw`ï¼‰ï¼Œæ‰€ä»¥ä»¿çœŸå›¾åƒæ ¹æœ¬è¿›ä¸æ¥ã€‚

ä¸‹é¢æˆ‘ç»™ä½ ä¸€æ¡ç›¸å¯¹â€œé è°±ã€å¯è½åœ°â€çš„è·¯çº¿ï¼š
1ï¸âƒ£ å…ˆè®© Webots çš„ e-puck åœ¨ ROS é‡ŒçœŸæ­£å‘å‡º `/camera` å›¾åƒï¼›
2ï¸âƒ£ ç„¶åæŠŠ apriltag æ£€æµ‹èŠ‚ç‚¹æ¥ä¸Šï¼›
3ï¸âƒ£ æœ€åå†æŠŠ sim_bridge æ¥å›å»ã€‚

---

## ä¸€ã€ä½ ç°åœ¨ä¸ºä»€ä¹ˆæ²¡æœ‰ camera topicï¼Ÿ

å®˜æ–¹çš„ `webots_ros2_epuck` ç¤ºä¾‹é‡Œï¼Œå…¶å®æ˜¯æœ‰ camera è¯é¢˜çš„ï¼Œæ–‡æ¡£é‡Œå†™å¾—å¾ˆæ¸…æ¥šï¼šç›¸æœºå›¾åƒé€šè¿‡ `/camera`ï¼ˆ`sensor_msgs/Image`ï¼‰å’Œ `/camera/camera_info` å‘å¸ƒã€‚

ä½†æ˜¯ä½ ç°åœ¨ `ros2 topic list` åªæœ‰è¿™äº›ï¼š

```text
/ps0 ~ /ps7
/scan
/tof
/odom
/tf
...
```

**æ²¡æœ‰ `/camera`**ï¼Œè¯´æ˜ï¼š

* ä½ ç°åœ¨ç”¨çš„ **æ˜¯ apt å®‰è£…çš„ webots_ros2_epuck ç‰ˆæœ¬**ï¼ˆè·¯å¾„åœ¨ `/opt/ros/humble/...`ï¼‰ï¼Œ
* è¿™ä¸ªç‰ˆæœ¬çš„é…ç½®é‡Œ **æ²¡æœ‰æŠŠ camera è®¾å¤‡å¯¼å‡ºåˆ° ROS**ï¼ˆå¯èƒ½æ˜¯ä¸ºäº†å…¼å®¹ä½æ€§èƒ½ç¡¬ä»¶ï¼ŒæŠŠç›¸æœºå…³äº†ï¼‰ã€‚

æ‰€ä»¥è¦æƒ³åœ¨ä»¿çœŸä¸­â€œç›´æ¥æµ‹è¯•â€ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯ï¼š

> æ¢æˆå¸¦ camera çš„ `webots_ros2_epuck` æºç ç‰ˆæœ¬ã€‚

---

## äºŒã€æ­¥éª¤ 1ï¼šä»æºç å®‰è£… webots_ros2ï¼ˆå¸¦ e-puck cameraï¼‰

### 1.1 æŠŠæºç æ‹‰åˆ°ä½ çš„ test_ws

```bash
cd ~/Unibots\ 2026/test_ws/src
git clone https://github.com/cyberbotics/webots_ros2.git
```

ï¼ˆå…‹éš†ä¼šæ¯”è¾ƒå¤§ï¼Œä½†åªéœ€è¦ä¸€æ¬¡ï¼‰

### 1.2 ç¼–è¯‘å¹¶è¦†ç›– apt ç‰ˆæœ¬

```bash
cd ~/Unibots\ 2026/test_ws
colcon build --symlink-install
source install/setup.bash
```

> è¿™æ ·ä¹‹åï¼Œ`webots_ros2_epuck` ä¼šä»¥ä½  **å·¥ä½œç©ºé—´é‡Œçš„æºç ç‰ˆæœ¬** ä¸ºå‡†ï¼Œè€Œä¸æ˜¯ `/opt/ros/humble` é‡Œé‚£ä¸ªè€ç‰ˆæœ¬ã€‚

---

## ä¸‰ã€æ­¥éª¤ 2ï¼šç”¨æ–°çš„ webots_ros2_epuck å¯åŠ¨ä½ çš„ Run.wbt

ç°åœ¨ç”¨ä½ å·²ç»æå¥½çš„ Run.wbt æ¥å¯åŠ¨ï¼š

```bash
source ~/Unibots\ 2026/test_ws/install/setup.bash
ros2 launch webots_ros2_epuck robot_launch.py world:=Run.wbt
```

ç„¶ååœ¨å¦ä¸€ä¸ªç»ˆç«¯é‡Œï¼š

```bash
source ~/Unibots\ 2026/test_ws/install/setup.bash
ros2 topic list
```

**ç›®æ ‡ï¼šä¸€å®šè¦çœ‹åˆ°ç±»ä¼¼ï¼š**

```text
/camera
/camera/camera_info
...
/ps0 ~ /ps7
/scan
/tof
/odom
...
```

å¦‚æœ `/camera` å‡ºç°äº† âœ…ï¼Œä½ å°±å·²ç»å®Œæˆäº† â€œWebots â†’ ROS å›¾åƒâ€ çš„å…³é”®ä¸€æ­¥ã€‚

> EN: After building `webots_ros2` from source, launching `webots_ros2_epuck robot_launch.py` should give you `/camera` and `/camera/camera_info` topics in `ros2 topic list`. Thatâ€™s your simulated camera.

---

## å››ã€æ­¥éª¤ 3ï¼šæ¥ä¸Š AprilTag æ£€æµ‹èŠ‚ç‚¹

æ¥ä¸‹æ¥å°±æ˜¯ä½ ä¹‹å‰é—®çš„é‚£æ¡é“¾è·¯ï¼š

> Webots camera â†’ apriltag_ros (æˆ–ä½ è‡ªå·±çš„èŠ‚ç‚¹) â†’ sim_bridge

è¿™é‡Œç»™ä½ ä¸€ä¸ª **å…¸å‹é…ç½®æ€è·¯**ï¼ˆå…·ä½“å‘½ä»¤è¦æ ¹æ®ä½ å®‰è£…çš„ apriltag åŒ…åå­—è°ƒæ•´ï¼‰ï¼š

1. å…ˆç¡®è®¤å›¾åƒèƒ½çœ‹åˆ°ï¼š

   ```bash
   # å¦å¼€ä¸€ä¸ªç»ˆç«¯
   ros2 run rqt_image_view rqt_image_view
   # åœ¨ GUI é‡Œé€‰æ‹© topic = /camera
   ```

   èƒ½çœ‹åˆ° e-puck è§†é‡é‡Œçš„åœºåœ°å°± OK äº†ã€‚

2. å¯åŠ¨ `ros2` ç‰ˆæœ¬çš„ apriltag æ£€æµ‹èŠ‚ç‚¹ï¼ˆä¸¾ä¾‹ï¼‰ï¼š

   ```bash
   # ä¼ªä»£ç ç¤ºä¾‹ï¼ŒçœŸå®å‘½ä»¤è¦çœ‹ä½ è£…çš„æ˜¯å“ªä¸ªåŒ…
   ros2 run apriltag_ros apriltag_node --ros-args \
     -r image:=/camera \
     -r camera_info:=/camera/camera_info
   ```

   æˆ–è€…å¦‚æœå®ƒæœ‰ç°æˆ launchï¼š

   ```bash
   ros2 launch apriltag_ros detector.launch.py \
     image_topic:=/camera \
     camera_info_topic:=/camera/camera_info
   ```

3. å†çœ‹æ£€æµ‹è¾“å‡ºçš„ topicï¼š

   ```bash
   ros2 topic list
   # æ‰¾ç±»ä¼¼ /tag_detections æˆ– /detections_3d ä¹‹ç±»çš„è¯é¢˜
   ```

   `ros2 topic echo` çœ‹ä¸€çœ¼ï¼Œç¡®è®¤åœ¨ tag æ­£å¯¹ç€æ‘„åƒå¤´çš„æ—¶å€™ï¼Œæœ‰æ•°æ®å‡ºæ¥ã€‚

---

## äº”ã€æ­¥éª¤ 4ï¼šsim_bridge æŒ‚ä¸ŠçœŸå®æ£€æµ‹

ä½ ä¹‹å‰å·²ç»ç”¨â€œå‡æ•°æ®â€æŠŠ sim_bridge è·‘é€šäº†ï¼Œå¯¹å§ âœ…
é‚£è¯´æ˜ä½ å·²ç»çŸ¥é“ï¼š

* sim_bridge **è®¢é˜…çš„è¾“å…¥ topic åå­—**ï¼ˆæ¯”å¦‚ `/tag_detections` / `/april_tag_pose` ç­‰ï¼‰ï¼›
* sim_bridge è¾“å‡ºäº† `/tf` æˆ– `/robot_pose` ä¹‹ç±»ã€‚

ç°åœ¨åªè¦æŠŠ **AprilTag èŠ‚ç‚¹å®é™…è¾“å‡ºçš„é‚£ä¸ª topic**ï¼Œæ”¹æˆè·Ÿä½ å½“æ—¶å‡æ•°æ®ç”¨çš„ä¸€è‡´å°±è¡Œï¼š

* è¦ä¹ˆï¼šåœ¨å¯åŠ¨ apriltag èŠ‚ç‚¹æ—¶ç”¨ `-r` é‡æ˜ å°„å®ƒçš„è¾“å‡ºåï¼›
* è¦ä¹ˆï¼šæ”¹ sim_bridge çš„å‚æ•°ï¼Œè®©å®ƒè®¢é˜… apriltag èŠ‚ç‚¹çœŸå®çš„è¾“å‡ºåã€‚

ä¾‹å¦‚ä½ ä¹‹å‰å‡æ•°æ®æ‰“çš„æ˜¯ `/tag_detections`ï¼Œé‚£ç°åœ¨å°±è®© apriltag èŠ‚ç‚¹è¾“å‡ºä¹Ÿå« `/tag_detections`ï¼š

```bash
ros2 run apriltag_ros apriltag_node --ros-args \
  -r image:=/camera \
  -r camera_info:=/camera/camera_info \
  -r tag_detections:=/tag_detections   # é‡å‘½åè¾“å‡º
```

è¿™æ · sim_bridge ä¸ç”¨æ”¹ï¼Œç›´æ¥å°±æ¥ä¸Šäº†ã€‚

> EN: Just make sure the AprilTag detector publishes on the **same topic name** you used for fake-data tests. Either remap the detectorâ€™s output topic or adjust `sim_bridge`â€™s input topic parameter.

---

## å…­ã€ä½ ç°åœ¨å¯ä»¥æ€ä¹ˆä¸€æ­¥æ­¥åšï¼ˆç»™ä½ ä¸€ä¸ª Checklistï¼‰

ä½ å¯ä»¥æŒ‰è¿™ä¸ªé¡ºåºæ¥ï¼š

1. âœ… ï¼ˆå·²ç»åšå®Œï¼‰å‡æ•°æ® â†’ sim_bridge è·‘é€šã€‚
2. âœ… ä»æºç å®‰è£… `webots_ros2`ï¼Œç”¨ Run.wbt å¯åŠ¨ï¼Œç¡®è®¤ `ros2 topic list` é‡Œå‡ºç° `/camera`ã€‚
3. âœ… ç”¨ rqt_image_view çœ‹ `/camera` å›¾åƒï¼Œç¡®è®¤ä»¿çœŸè§†è§’æ­£å¸¸ã€‚
4. âœ… å¯åŠ¨ AprilTag æ£€æµ‹èŠ‚ç‚¹ï¼Œè®¢é˜… `/camera` å’Œ `/camera/camera_info`ã€‚
5. âœ… ç”¨ `ros2 topic echo` çœ‹ tag æ£€æµ‹ç»“æœï¼Œç¡®è®¤æœ‰æ•°æ®ã€‚
6. âœ… ç¡®è®¤è¿™ä¸ªæ£€æµ‹ topic åç§°è·Ÿ sim_bridge è®¢é˜…çš„ä¸€è‡´ï¼ˆæˆ–é€šè¿‡ remap å¯¹ä¸Šï¼‰ã€‚
7. âœ… å¯åŠ¨ sim_bridgeï¼Œçœ‹å®ƒçš„è¾“å‡ºï¼ˆ/tf æˆ– /robot_poseï¼‰éšç€æœºå™¨äººåœ¨ä»¿çœŸé‡Œç§»åŠ¨è€Œå˜åŒ–ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥ä½ å¯ä»¥æŠŠï¼š

* `ros2 node info <sim_bridgeèŠ‚ç‚¹å>` çš„è¾“å‡ºï¼Œ
* ä»¥åŠ `ros2 topic list` é‡Œè·Ÿ camera / tag detection æœ‰å…³çš„åå­—

è´´ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ å†™å‡ºä¸€å¥—**å®Œæ•´çš„å¯åŠ¨æŒ‡ä»¤ç»„åˆ**ï¼ˆå“ªå‡ ä¸ªç»ˆç«¯åˆ†åˆ«æ•²å“ªå‡ æ¡å‘½ä»¤ï¼‰ï¼Œä½ åªè¦ç…§ç€å¼€å°±èƒ½å®Œæˆâ€œä»¿çœŸç›´æ¥æµ‹è¯•â€ã€‚





å¤ªå¥½äº†ï¼Œç°åœ¨ç»ˆäºåˆ°â€œçœŸ Webots + çœŸ e-puck + ä½ çš„ sim_bridge å…¨é“¾è·¯è”è°ƒâ€è¿™ä¸€æ­¥äº† ğŸ‰

ä½ ç°åœ¨çš„ `ros2 topic list` æ˜¯ï¼š

```text
/epuck/camera/image_raw
/odom
/scan
/tf
...
```

**å…³é”®ç‚¹ï¼šåªæœ‰ `/epuck/camera/image_raw`ï¼Œæ²¡æœ‰ `/camera_info`ã€‚**
è€Œ `apriltag_ros` **å¿…é¡»è¦** `/camera_info`ï¼Œå¦åˆ™å®ƒæ²¡æ³•ç®—ä½å§¿ã€‚

æ‰€ä»¥æˆ‘ä»¬è¦åšçš„äº‹å¯ä»¥åˆ†æˆ 4 å¤§æ­¥ï¼š

1. å†™ä¸€ä¸ªå°èŠ‚ç‚¹ï¼šç»™ e-puck ç›¸æœºè¡¥ä¸€ä¸ª `/epuck/camera/camera_info`ã€‚
2. æ‰¾å‡ºç›¸æœºçš„ frame åå­—ï¼ˆç»™ `camera_optical_frame` ç”¨ï¼‰ã€‚
3. ç”¨çœŸå®ç›¸æœºå›¾åƒ + camera_info è·‘ `apriltag_ros`ã€‚
4. ç”¨ä½ å·²ç»å†™å¥½çš„ `pv_sim_bridge` + RViz çœ‹åœºä¸Šå§¿æ€ã€‚

æˆ‘ä¸€æ­¥æ­¥å†™ï¼Œä½ å¯ä»¥ç›´æ¥ç…§ç€åšã€‚

---

## ç¬¬ 1 æ­¥ï¼šç»™ e-puck ç›¸æœºâ€œé€ â€ä¸€ä¸ª CameraInfo è¯é¢˜

### 1.1 åœ¨ä½ çš„åŒ…é‡ŒåŠ ä¸€ä¸ª Python èŠ‚ç‚¹

å‡è®¾ä½ ç°åœ¨ç”¨çš„æ˜¯ `pv_apriltag` è¿™ä¸ªåŒ…ï¼Œå°±æŠŠä»£ç æ”¾é‡Œé¢æœ€æ–¹ä¾¿ã€‚

åœ¨å·¥ä½œç©ºé—´é‡Œæ–°å»ºæ–‡ä»¶ï¼š

```bash
cd ~/Unibots\ 2026/test_ws/src/pv_apriltag/pv_apriltag
nano epuck_camera_info_node.py
```

ç²˜è´´ä¸‹é¢è¿™æ®µä»£ç ï¼ˆå°½é‡åŸæ ·å¤åˆ¶ï¼‰ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import rclpy
from rclpy.node import Node
from sensor_msgs.msg import Image, CameraInfo

class EpuckCameraInfoNode(Node):
    """
    ä» /epuck/camera/image_raw æ‹¿åˆ°å›¾åƒçš„åˆ†è¾¨ç‡ï¼Œ
    æ„é€ ä¸€ä¸ªç®€å•çš„ CameraInfoï¼Œå‘å¸ƒåˆ° /epuck/camera/camera_infoã€‚

    è¿™é‡Œçš„å†…å‚æ˜¯â€œçå†™ä¸€ä¸ªå¤§æ¦‚å€¼â€ï¼Œè¶³å¤Ÿè®© apriltag_ros å·¥ä½œå¹¶è¾“å‡ºå§¿æ€ã€‚
    çœŸæ­£è¦ç²¾åº¦æ—¶å†åšæ ‡å®šã€‚
    """

    def __init__(self):
        super().__init__('epuck_camera_info_node')

        # è®¢é˜…å›¾åƒï¼Œç”¨æ¥æ‹¿ width / height å’Œæ—¶é—´æˆ³
        self.sub = self.create_subscription(
            Image,
            '/epuck/camera/image_raw',
            self.image_callback,
            10
        )

        # å‘å¸ƒ camera_info
        self.pub = self.create_publisher(CameraInfo,
                                         '/epuck/camera/camera_info',
                                         10)

        self.info_msg = None
        self.get_logger().info('[epuck_camera_info_node] Started, waiting for /epuck/camera/image_raw ...')

    def image_callback(self, msg: Image):
        # ç¬¬ä¸€æ¬¡æ”¶åˆ°å›¾åƒæ—¶ï¼Œæ ¹æ®åˆ†è¾¨ç‡åˆå§‹åŒ–ä¸€ä¸ª CameraInfo
        if self.info_msg is None:
            info = CameraInfo()
            info.width = msg.width
            info.height = msg.height

            # ç²—ç•¥çš„å†…å‚ï¼šå‡è®¾ fx = fy = 500ï¼Œå…‰å¿ƒåœ¨å›¾åƒä¸­å¿ƒ
            fx = fy = 500.0
            cx = info.width / 2.0
            cy = info.height / 2.0

            # å†…å‚çŸ©é˜µ K
            info.k = [fx, 0.0, cx,
                      0.0, fy, cy,
                      0.0, 0.0, 1.0]

            # æŠ•å½±çŸ©é˜µ Pï¼ˆç®€å•å¤åˆ¶ Kï¼‰
            info.p = [fx, 0.0, cx, 0.0,
                      0.0, fy, cy, 0.0,
                      0.0, 0.0, 1.0, 0.0]

            # è¿™é‡Œçš„ frame_id è¦å’ŒçœŸæ­£çš„ç›¸æœºåæ ‡ç³»ä¸€è‡´
            # å…ˆç”¨å›¾åƒæœ¬èº«çš„ frame_idï¼Œåé¢å¦‚æœä½ æŸ¥åˆ°äº†ä¸“é—¨çš„ optical frameï¼Œå¯ä»¥å†æ”¹
            info.header.frame_id = msg.header.frame_id or 'epuck_camera_frame'

            self.info_msg = info
            self.get_logger().info(
                f'[epuck_camera_info_node] Initialized CameraInfo: '
                f'{info.width}x{info.height}, fx={fx}, cx={cx}, cy={cy}, frame_id={info.header.frame_id}'
            )

        # æ¯æ¥ä¸€å¸§å›¾åƒï¼Œå°±åŒæ­¥ stamp & frame_id å†å‘å¸ƒ
        self.info_msg.header.stamp = msg.header.stamp
        # å¦‚æœå›¾åƒçš„ frame_id æœ‰å€¼ï¼Œå°±ä¿æŒä¸€è‡´
        if msg.header.frame_id:
            self.info_msg.header.frame_id = msg.header.frame_id

        self.pub.publish(self.info_msg)

def main():
    rclpy.init()
    node = EpuckCameraInfoNode()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

ä¿å­˜é€€å‡ºã€‚

### 1.2 åœ¨ `setup.py` é‡Œæ³¨å†Œè¿™ä¸ªèŠ‚ç‚¹

æ‰“å¼€ `~/Unibots 2026/test_ws/src/pv_apriltag/setup.py`ï¼š

```bash
nano ~/Unibots\ 2026/test_ws/src/pv_apriltag/setup.py
```

åœ¨ `entry_points` é‡ŒåŠ ä¸€è¡Œï¼ˆæ³¨æ„é€—å·ï¼‰ï¼š

```python
entry_points={
    'console_scripts': [
        'pv_sim_bridge = pv_apriltag.pv_sim_bridge:main',
        'epuck_camera_info = pv_apriltag.epuck_camera_info_node:main',
    ],
},
```

ä¿å­˜é€€å‡ºã€‚

### 1.3 é‡æ–°ç¼–è¯‘

```bash
cd ~/Unibots\ 2026/test_ws
colcon build --symlink-install
source install/setup.bash
```

### 1.4 è¿è¡Œ e-puck camera_info èŠ‚ç‚¹

ç¡®ä¿ Webots + e-puck å·²ç»åœ¨è·‘ï¼ˆä½ å·²ç»èƒ½çœ‹åˆ° `/epuck/camera/image_raw`ï¼‰ã€‚
ç„¶åå¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

ros2 run pv_apriltag epuck_camera_info
```

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
ros2 topic list | grep camera
```

ä½ åº”è¯¥çœ‹åˆ°å¤šäº†ï¼š

```text
/epuck/camera/image_raw
/epuck/camera/camera_info
```

è¿™ä¸€æ­¥å°±ç®—æˆåŠŸäº† âœ…

---

## ç¬¬ 2 æ­¥ï¼šç¡®å®š camera çš„ frame åå­—ï¼ˆç»™ sim_bridge ç”¨ï¼‰

`apriltag_ros` ä¼šæŠŠ TF çš„çˆ¶åæ ‡ç³»è®¾ä¸º **`camera_info.header.frame_id`**ï¼Œç°åœ¨æˆ‘ä»¬åœ¨ node é‡Œæ˜¯è¿™æ ·è®¾ç½®çš„ï¼š

```python
info.header.frame_id = msg.header.frame_id or 'epuck_camera_frame'
```

æ‰€ä»¥ï¼š

* å¦‚æœ e-puck å›¾åƒæœ¬èº«çš„ `header.frame_id` ä¸ä¸ºç©ºï¼Œå°±ç”¨å®ƒï¼›
* å¦åˆ™å°±ç”¨ `'epuck_camera_frame'`ã€‚

ä½ å¯ä»¥æŸ¥ä¸€ä¸‹å®é™…å€¼ï¼š

```bash
ros2 topic echo /epuck/camera/image_raw -n 1
```

çœ‹é‡Œé¢çš„ï¼š

```text
header:
  frame_id: "xxxx"
```

ç„¶åå†æŸ¥ä¸€æ¬¡ camera_infoï¼š

```bash
ros2 topic echo /epuck/camera/camera_info -n 1
```

ç¡®è®¤å®ƒçš„ `header.frame_id` æ˜¯ä»€ä¹ˆã€‚
**è¿™ä¸ªåå­—å°±æ˜¯ä½ è¦ç»™ `pv_sim_bridge` çš„ `camera_optical_frame`ã€‚**

å¦‚æœ image é‡Œè¿˜æ˜¯ç©ºçš„ï¼Œä½ ä¼šçœ‹åˆ°æˆ‘ä»¬è®¾æˆäº† `epuck_camera_frame`ï¼Œé‚£ä¹ˆå°±ç»Ÿä¸€ç”¨è¿™ä¸ªåå­—ã€‚

---

## ç¬¬ 3 æ­¥ï¼šç”¨ e-puck ç›¸æœº + camera_info å¯åŠ¨ apriltag_ros

æœ‰äº† `/epuck/camera/camera_info` åï¼Œç°åœ¨å¯ä»¥æ­£å¼è·‘ Tag æ£€æµ‹äº†ã€‚

æ–°å¼€ç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

ros2 run apriltag_ros apriltag_node --ros-args \
  -r image:=/epuck/camera/image_raw \
  -r camera_info:=/epuck/camera/camera_info \
  -p family:=tag36h11 \
  -p size:=0.10
```

æŠŠ e-puck çš„ç›¸æœºåœ¨ Webots é‡Œå¯¹ç€ä¸€é¢å¢™çš„ AprilTagï¼Œ
ç„¶åå†å¼€ç»ˆç«¯ï¼š

```bash
ros2 topic echo /tf | grep tag36h11
```

å¦‚æœèƒ½çœ‹åˆ°ç±»ä¼¼ï¼š

```text
header:
  frame_id: epuck_camera_frame   # æˆ–ä½ çš„çœŸå® frame
child_frame_id: tag36h11:0
...
```

è¯´æ˜ **apriltag_ros å·²ç»å¼€å§‹æ£€æµ‹å¹¶åœ¨ TF ä¸­å‘å¸ƒ camâ†’tag äº†** âœ…ã€‚

---

## ç¬¬ 4 æ­¥ï¼šç”¨çœŸå®é“¾è·¯è·‘ pv_sim_bridge + RViz

### 4.1 ç¡®ä¿ pv_sim_bridge çš„å‚æ•°é‡Œ camera_optical_frame ä¸€è‡´

æ‰“å¼€ä½ çš„ params æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

```bash
nano src/pv_apriltag/pv_apriltag/config/pv_sim_bridge.params.yaml
```

ç¡®è®¤é‡Œé¢æ˜¯ç±»ä¼¼ï¼š

```yaml
pv_sim_bridge:
  ros__parameters:
    camera_optical_frame: "epuck_camera_frame"   # æˆ–åˆšæ‰ä½ çœ‹åˆ°çš„é‚£ä¸ª frame_id
    robot_to_cam_xyz_rpy: [0.05, 0.0, 0.05, 0.0, 0.0, 0.0]

    field_layout: '{
      "tag36h11:0":  [-0.85,  1.0, 0.075, 0.0, 0.0, -1.5708],
      ...
      "tag36h11:23": [-1.0, -0.85, 0.075, 0.0, 0.0,  0.0]
    }'
```

ä¿å­˜åï¼Œä¸éœ€è¦é‡æ–° buildï¼ˆè¿™æ˜¯çº¯å‚æ•°æ–‡ä»¶ï¼‰ã€‚

### 4.2 å¯åŠ¨ sim_bridge

æ–°å¼€ç»ˆç«¯ï¼š

```bash
cd ~/Unibots\ 2026/test_ws
source install/setup.bash

ros2 run pv_apriltag pv_sim_bridge \
  --ros-args \
  --params-file src/pv_apriltag/pv_apriltag/config/pv_sim_bridge.params.yaml
```

çœ‹æ—¥å¿—ï¼Œä¸è¦å†æœ‰ â€œfield_layout å‚æ•°æ— æ³•è§£æâ€ ä¹‹ç±»çš„ warnï¼Œæœ€å¥½å‡ºç°ç±»ä¼¼ï¼š

```text
[pv_sim_bridge] ready. cam_frame=epuck_camera_frame, tags=24
```

### 4.3 æ£€æŸ¥ /pv è¯é¢˜

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```bash
ros2 topic list | grep ^/pv
ros2 topic echo /pv/has_target
```

åœ¨ Webots é‡Œæ§åˆ¶ e-puck ç›¸æœºå¯¹ç€ Tagï¼š

* `/pv/has_target` â†’ å˜æˆ `true`ï¼›
* `ros2 topic echo /pv/estimated_robot_pose`ï¼šå¼€å§‹åˆ·ä½å§¿ï¼›
* `ros2 topic echo /pv/target_yaw_deg`ï¼šæœ‰æ•°ï¼›
* `ros2 topic echo /pv/robot_yaw_deg`ï¼šæœ‰ yawã€‚

### 4.4 åœ¨ RViz é‡Œçœ‹ç»“æœ

```bash
rviz2
```

* Fixed Frame = `map`
* Add â†’ Pose â†’ `/pv/estimated_robot_pose`
* ä½ åº”è¯¥çœ‹åˆ°ä¸€ä¸ªç®­å¤´è¡¨ç¤º e-puck åœ¨åœºåœ°ä¸­çš„ä½ç½®å’Œæœå‘ã€‚

åœ¨ Webots é‡Œï¼š

* è®© e-puck åŸåœ°è½¬ 90Â°ï¼šRViz é‡Œçš„ç®­å¤´ä¹Ÿåº”è¯¥è½¬ 90Â°ï¼Œ`/pv/robot_yaw_deg` å¯¹åº”å˜åŒ–ã€‚
* è®© e-puck æ²¿ç€æŸæ¡è¾¹èµ°ï¼šç®­å¤´ä½ç½®åº”è¯¥åœ¨ map é‡Œå¯¹åº”ç§»åŠ¨ã€‚

---

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä½ å°±å·²ç»å®Œæˆäº†ï¼š

> e-puck ç›¸æœº `/epuck/camera/image_raw`
> â†’ è‡ªå·±è¡¥çš„ `/epuck/camera/camera_info`
> â†’ `apriltag_ros` æ£€æµ‹ Tag å¹¶å‘å¸ƒ TF
> â†’ `pv_sim_bridge` ç”¨åœºåœ°å¸ƒå±€ + å¤–å‚ç®— map ä¸‹çš„æœºå™¨äººä½å§¿
> â†’ `/pv/estimated_robot_pose`ã€`/pv/target_yaw_deg`ã€`/pv/robot_yaw_deg`
> â†’ RViz çœ‹å…¨å±€å§¿æ€å’Œæœå‘

**è¿™å°±æ˜¯ä½ æƒ³è¦çš„â€œWebots + sim_bridge è”æµ‹â€çš„å®Œæ•´æ­¥éª¤** âœ…

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ä¸“é—¨å¸®ä½ å†™ä¸€ä¸ª `pv_debug_yaw.py`ï¼Œ
åªåšä¸€ä»¶äº‹ï¼šè®¢é˜… `/pv/estimated_robot_pose` + `/pv/target_yaw_deg`ï¼Œ
æ¯ä¸€å¸§æ‰“å°ä¸€è¡Œï¼š

```text
robot_yaw =  87.3 deg | target_yaw = -4.5 deg
```

è¿™æ ·ä½ è°ƒæ§åˆ¶å’Œç®—æ³•çš„æ—¶å€™ä¼šéå¸¸ç›´è§‚ã€‚
